"0","runs <- levels(combined_df$run)"
"0","for (r in runs) {"
"0","  df_sub <- combined_df %>% filter(run == r)"
"0",""
"0","  if (nrow(df_sub) < 4) {"
"0","    warning(paste(""Skipping run"", r, ""- not enough data""))"
"0","    next"
"0","  }"
"0","#df_sub <- combined_df %>% filter(run == ""run1"")"
"0","  # Fit models"
"0","  model_linear <- lm(Xred ~ PE_scaled, data = df_sub)"
"0","  model_log    <- lm(Xred ~ log(PE_scaled + 0.001), data = df_sub)"
"0","  model_poly   <- lm(Xred ~ PE_scaled + I(PE_scaled^2), data = df_sub)"
"0",""
"0","  # Get annotation"
"0","  ann_linear <- get_stats(model_linear, ""Linear"")"
"0","  ann_log    <- get_stats(model_log, ""Log"")"
"0","  ann_poly   <- get_stats(model_poly, ""Poly"")"
"0",""
"0","  # Plot"
"0","  p <- ggplot(df_sub, aes(x = PE_scaled, y = Xred)) +"
"0","    geom_point(alpha = 0.6, color = ""black"") +"
"0","    geom_text_repel(aes(label = join_id), size = 2, max.overlaps = 50) +"
"0","    stat_smooth(method = ""lm"", formula = y ~ x, se = FALSE, color = ""blue"") +"
"0","    stat_smooth(method = ""lm"", formula = y ~ log(x + 0.001), se = FALSE, color = ""green"", linetype = ""dashed"") +"
"0","    stat_smooth(method = ""lm"", formula = y ~ x + I(x^2), se = FALSE, color = ""red"", linetype = ""dotdash"") +"
"0","    annotate(""text"", x = Inf, y = Inf, label = ann_linear, hjust = 1.05, vjust = 2, color = ""blue"", size = 4) +"
"0","    annotate(""text"", x = Inf, y = Inf, label = ann_log, hjust = 1.05, vjust = 3.5, color = ""green"", size = 4) +"
"0","    annotate(""text"", x = Inf, y = Inf, label = ann_poly, hjust = 1.05, vjust = 5, color = ""red"", size = 4) +"
"0","    theme_minimal() +"
"0","    labs(title = paste(""Regression Models: Xred vs PE ("", r, "")""),"
"0","         x = ""PE (mg/g sample)"","
"0","         y = ""Xred Fluorescence"")"
"0",""
"0","  # Save plot"
"0","  filename <- paste0(""Xred_PE_regressions_"", r, "".png"")"
"0","  ggsave(filename, plot = p, width = 10, height = 6, dpi = 300)"
"0","  plot(p)"
"0","}"
