---
title: "Protein Content Analysis using the Lowry Method"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Load script
```{r}
# Source script from top-level project folder
source("../process_plate_run.R")
#
```

## Load input data
```{r load-excel-files, warning=FALSE}
# 1. Define the folder containing all Excel inputs
input_folder <- "Input_prot"

# 2. Find all .xlsx files (full paths), excluding temp files that start with "~$"
excel_files <- list.files(
  path = input_folder, 
  pattern = "\\.xlsx?$", 
  full.names = TRUE
)
excel_files <- excel_files[!grepl("^~\\$", basename(excel_files))]

# 3. Loop over each file
for (file in excel_files) {
  # 3a. Create a clean object name (strip out folder & extension)
  name <- tools::file_path_sans_ext(basename(file))
  
  # 3b. Determine which sheet to read (second if possible, otherwise first)
  sheet_names   <- excel_sheets(file)
  sheet_to_read <- if (length(sheet_names) >= 2) sheet_names[2] else sheet_names[1]
  
  # 3c. Read the chosen sheet, suppressing verbose messages
  data <- suppressMessages(read_excel(file, sheet = sheet_to_read))
  
  # 3d. Assign the data.frame to the global environment under "name"
  assign(name, data, envir = .GlobalEnv)
  
  # 3e. Print a message to confirm successful load
  message("Loaded: ", name, " (sheet = '", sheet_to_read, "')")
}
```

### Tidy photospectrometer input data into dataframes and correct blanks
```{r tidy-processing}
# 1. Define which wells were used as blanks in each run
blanks1 <- c("A01", "A02", "A03")
blanks2 <- c("H11", "H12")
#
# 2. Build named lists of raw datasets and their corresponding blank vectors
listprot    <- list(pr1 = pr1, pr2 = pr2)
#
listBlanks <- list(blanks1, blanks2)
#
# 3. Run the wrapper: it calls tidy_and_correct() on each dataset
tidy_all(listprot, listBlanks)  # Produces PE1_tidy, PE2_tidy, PE3_tidy, PE4_tidy

```
## STEP 5: JOIN THE DATA WITH ITS SAMPLE WEIGHTS SPREADSHEET

Description of `joindf_by_id` Function

The `joindf_by_id` function takes two data frames (`df1` and `df2`) and merges them by matching unique identifiers related to samples, specifically using either a `Cell_ID` column or a `plate well` column.\
**Key steps and features:** - **Column Cleaning:** Trims whitespace from column names in both data frames to avoid join errors caused by accidental spaces.
- **Key Column Verification:** Checks that at least one data frame contains a `Cell_ID` column and the other contains a `plate well` column—these serve as the join keys.
- **Role Assignment:** Depending on which data frame contains `Cell_ID`, that data frame is assigned as the base (`df_cell`), and the other becomes the joining data (`df_plate`).
- **Rename Join Keys:** Renames both join columns to a common key name (`join_id`) to facilitate a straightforward left join.
- **Perform Join:** Conducts a left join, keeping all rows from the base data frame and adding matching data from the other.
- **Identify Unmatched Rows:** Any rows in the larger data frame without matches are saved separately for troubleshooting.
- **Output Files:**\
- Saves the merged data frame as a CSV named according to the provided `output_name`.\
- Writes unmatched rows into a separate CSV file.\
- **Global Environment Assignment:** Assigns the merged data frame into the global R environment under the same name as the output file (minus the `.csv` extension).
- **Reporting:** Prints messages listing any unmatched identifiers and returns a summary report containing counts of matched/unmatched rows and file paths of saved CSVs.

```{r join-weights, warning=FALSE}
# 1. Create output subdirectory
save_dir <- file.path("output_prot", "export data", "joined_weights_prot")
dir.create(save_dir, recursive = TRUE, showWarnings = FALSE)

# 2. Build weight and PE data frame lists
list_weights <- list(
  pr1_weights,
  pr2_weights
)

pr_list <- list(
  pr1 = pr1_tidy, 
  pr2 = pr2_tidy
)

# 3. Loop and join
mapply(
  function(df1, df2, name) {
    joindf_by_id(
      df1          = df1,
      df2          = df2,
      output_name  = file.path(save_dir, paste0(name, "_weights_joined.csv")),
      unmatched_out = file.path(save_dir, paste0(name, "_weights_unmatched.csv")),
      key_df1      = "Cell_ID",
      key_df2      = "plate well"
    )
  },
  df1 = pr_list,
  df2 = list_weights,
  name = names(pr_list),
  SIMPLIFY = FALSE
)

```

## Create Standard Curve from Lowry Assay

```{r}
```{r standard-curve, message=FALSE, warning=FALSE}

# Example data: Replace this with your actual data
# You can also use `read.csv("your_data.csv")` if loading from a file

# Fit linear model
model <- lm(X600_cor ~ concentration, data = calibration_prot)

# Summary of the model (for table output, if needed)
summary(model)

# Plot
ggplot(calibration_prot, aes(x = concentration, y = X600_cor)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(
    title = "Protein Standard Curve (Lowry Method)",
    x = "Protein Concentration (mg/mL)",
    y = "Absorbance (600 nm)"
  ) +
  annotate(
    "text", x = max(calibration_prot$concentration) * 0.5, 
    y = max(calibration_prot$X600_cor) * 0.9,
    label = paste0("y = ", round(coef(model)[2], 4), "x + ", round(coef(model)[1], 4),
                   "\nR² = ", round(summary(model)$r.squared, 4)),
    size = 4, hjust = 0
  ) +
  theme_minimal()

```
## Analyze Replicates
```{r}
rep_summary <- analyze_replicates(protein_tidy,
                                  id_col = "ID",
                                  join_col = "join_id",
                                  weight_col = "sample weight",
                                  date_col = "date",
                                  output_prefix = "protein_analysis",
                                  choose_best_3 = TRUE)
```
## Visualize Protein Content Across Replicates
```{r}
graph_replicates_custom_error(rep_summary,
                              id_col = "ID",
                              value_col = "Protein_mg_per_mL_mean",
                              se_col = "Protein_mg_per_mL_se")
```